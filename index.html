<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ POOL Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- SheetJS for XLSX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a polished UI/UX */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for active sidebar link */
        .sidebar-active {
            background-color: #4f46e5; /* Indigo 600 */
            color: #ffffff;
            font-weight: 600;
        }
         .sidebar-link:hover {
            background-color: #3730a3; /* Indigo 800 */
        }
        /* Toggle switch styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- Upload Section - Fullscreen initially -->
    <div id="upload-section" class="flex items-center justify-center min-h-screen bg-slate-50">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 text-center">
            <header class="mb-10">
                <img src="https://sakya.edu.lk/assets/images/logo/logo.png" alt="Sakya Education Logo" class="mx-auto h-16 w-auto mb-4">
                <h1 class="text-4xl font-bold text-slate-800 tracking-tight">MCQ POOL Dashboard</h1>
                <p class="text-slate-500 mt-2">Dynamic analysis of student performance data.</p>
            </header>
            <div class="bg-white max-w-2xl mx-auto shadow-sm rounded-xl p-8 border border-slate-200">
                <h2 class="text-2xl font-semibold text-slate-700 mb-2">Welcome! Let's Get Started.</h2>
                <p class="text-slate-500 mb-6 max-w-md mx-auto">Upload your XLSX file to generate the interactive dashboard.</p>
                
                <!-- Notice Box -->
                <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 text-left rounded-r-lg">
                    <div class="flex">
                        <div class="py-1"><svg class="h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div>
                        <div>
                            <p class="font-bold text-red-800">Notice: Please check file name before uploading.</p>
                            <p class="text-sm text-red-700">The required format is: <br><code class="font-mono text-xs bg-red-100 p-1 rounded">Year MCQ Pool _Subject Day XX (Responses).xlsx</code></p>
                        </div>
                    </div>
                </div>

                <div class="border-2 border-dashed border-slate-300 rounded-lg p-10 hover:border-indigo-500 transition-colors duration-300 bg-slate-50">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx">
                    <label id="file-input-label" for="file-input" class="cursor-pointer bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105 inline-block shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        Select XLSX File
                    </label>
                    <p id="file-name" class="text-slate-600 mt-4 text-sm"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Layout - Hidden by default -->
    <div id="dashboard-layout" class="hidden flex h-screen bg-slate-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-800 text-slate-300 flex flex-col">
            <div class="h-20 flex items-center justify-center p-4 bg-slate-900">
                <img src="https://sakya.edu.lk/assets/images/logo/logo.png" alt="Sakya Education Logo" class="h-10 w-auto"/>
            </div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-6 space-y-2">
                <button onclick="changeView(event, 'overview')" class="w-full flex items-center py-2.5 px-4 rounded-lg transition-colors duration-200 sidebar-link sidebar-active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    Overview
                </button>
                <button onclick="changeView(event, 'student-performance')" class="w-full flex items-center py-2.5 px-4 rounded-lg transition-colors duration-200 sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.293 3.293A1 1 0 0016 3H4a1 1 0 00-.707 1.707L5.586 7H4a1 1 0 00-1 1v2a1 1 0 001 1h1.586l-2.293 2.293a1 1 0 101.414 1.414L7 12.707V15a1 1 0 001 1h4a1 1 0 001-1v-2.293l2.293 2.293a1 1 0 001.414-1.414L14.414 11H16a1 1 0 001-1V8a1 1 0 00-1-1h-1.586l2.293-2.293A1 1 0 0017.293 3.293zM9 11a1 1 0 112 0 1 1 0 01-2 0z" />
                    </svg>
                    Top Rankers
                </button>
                <button onclick="changeView(event, 'branch-analysis')" class="w-full flex items-center py-2.5 px-4 rounded-lg transition-colors duration-200 sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Branch Analysis
                </button>
                <button onclick="changeView(event, 'question-analysis')" class="w-full flex items-center py-2.5 px-4 rounded-lg transition-colors duration-200 sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                    Question Analysis
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm h-20 flex items-center justify-between px-8">
                <h1 id="view-title" class="text-2xl font-bold text-slate-800">Overview</h1>
                <div id="dataset-name-container" class="hidden text-right">
                    <p class="text-sm font-medium text-slate-500">Dataset</p>
                    <p id="dataset-name" class="text-lg font-semibold text-indigo-600"></p>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-8">
                <!-- View Content -->
                <div id="overview" class="view-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:items-start">
                        <!-- Column 1: Top Rankers -->
                        <div class="lg:col-span-1">
                             <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full">
                                <h3 class="text-xl font-semibold text-slate-700 pb-4 mb-4 border-b border-slate-200">Top Rankers</h3>
                                <div id="top-rankers-list" class="space-y-2 max-h-[33rem] overflow-y-auto">
                                    <!-- Rankers will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        <!-- Column 2: Score Distribution -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                             <h3 class="text-xl font-semibold text-slate-700 pb-4 mb-4 border-b border-slate-200">Score Distribution</h3>
                             <div class="flex items-center space-x-4 mb-4">
                                <div class="flex items-center">
                                    <span class="text-sm font-medium text-gray-500 mr-2">Count</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="score-dist-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onchange="renderScoreDistributionChart()"/>
                                        <label for="score-dist-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900">Percentage</span>
                                </div>
                            </div>
                             <div class="h-[28rem]"><canvas id="score-distribution-chart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="student-performance" class="view-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xl font-semibold text-slate-700 pb-4 mb-4 border-b border-slate-200">Top Rankers List</h3>
                         <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <input type="text" id="student-search" placeholder="Search by name or ID..." class="w-full md:w-1/3 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <select id="branch-filter-table" class="w-full md:w-1/4 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Rank</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student ID</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Branch</th>
                                        <th class="py-3 px-6 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="student-table-body" class="bg-white divide-y divide-slate-200 text-sm text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="branch-analysis" class="view-content hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex justify-between items-center pb-4 mb-4 border-b border-slate-200">
                                <h3 class="text-xl font-semibold text-slate-700">Student Distribution</h3>
                                <button id="toggle-branch-dist-btn" onclick="toggleBranchDistVisibility()" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Hide</button>
                            </div>
                             <div class="flex items-center space-x-4 mb-4">
                                <div class="flex items-center">
                                    <span class="text-sm font-medium text-gray-500 mr-2">Count</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="branch-dist-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onchange="renderBranchCharts()"/>
                                        <label for="branch-dist-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900">Percentage</span>
                                </div>
                            </div>
                            <div id="branch-dist-chart-container" class="h-96"><canvas id="branch-distribution-chart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-xl font-semibold text-slate-700 pb-4 mb-4 border-b border-slate-200">Average Score by Branch</h3>
                            <div class="h-96"><canvas id="branch-performance-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <div id="question-analysis" class="view-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xl font-semibold text-slate-700 pb-4 mb-4 border-b border-slate-200">Question Response Analysis</h3>
                         <div class="mb-4">
                            <label for="question-select" class="block text-sm font-medium text-slate-700">Select a Question:</label>
                            <select id="question-select" class="mt-1 block w-full md:w-1/2 p-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                         </div>
                         <div class="flex items-center space-x-4 mb-4">
                            <div class="flex items-center">
                                <span class="text-sm font-medium text-gray-500 mr-2">Count</span>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="question-analysis-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onchange="renderQuestionAnalysisChart()"/>
                                    <label for="question-analysis-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                                <span class="text-sm font-medium text-gray-900">Percentage</span>
                            </div>
                        </div>
                        <div class="h-96"><canvas id="question-analysis-chart"></canvas></div>
                    </div>
                </div>
            </main>
            <footer class="text-center py-4 px-8 text-xs text-slate-500 bg-white border-t border-slate-200">
                <p>&copy; 2025 <a href="https://sakya.edu.lk" target="_blank" class="text-indigo-600 hover:underline font-semibold">Sakya</a> MCQ POOL Dashboard | Built with ❤️ for Sakya MCQ POOL Team</p>
                <p class="mt-1">Developed by <a href="https://pasindulakshan.com" target="_blank" class="text-indigo-600 hover:underline font-semibold">Pasindu Lakshan Perera</a></p>
            </footer>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const fileInput = document.getElementById('file-input');
    const fileInputLabel = document.getElementById('file-input-label');
    const fileNameDisplay = document.getElementById('file-name');
    const uploadSection = document.getElementById('upload-section');
    const dashboardLayout = document.getElementById('dashboard-layout');
    const sidebarButtons = document.querySelectorAll('#sidebar-nav button');
    const viewTitle = document.getElementById('view-title');
    const datasetNameContainer = document.getElementById('dataset-name-container');
    const datasetNameEl = document.getElementById('dataset-name');

    // Chart instances
    let scoreDistributionChart, branchDistributionChart, branchPerformanceChart, questionAnalysisChart;
    
    // Global data storage
    let studentData = [];
    let questionColumns = [];
    let currentFileName = '';

    // --- Utility Functions ---
    /**
     * Debounce function to limit the rate at which a function gets called.
     */
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // --- Event Listeners ---
    fileInput.addEventListener('change', handleFileUpload);
    document.getElementById('student-search').addEventListener('input', debounce(renderStudentTable, 300));
    document.getElementById('branch-filter-table').addEventListener('change', renderStudentTable);
    document.getElementById('question-select').addEventListener('change', renderQuestionAnalysisChart);

    /**
     * Toggles visibility of the branch distribution chart
     */
    function toggleBranchDistVisibility() {
        const container = document.getElementById('branch-dist-chart-container');
        const button = document.getElementById('toggle-branch-dist-btn');
        container.classList.toggle('hidden');
        button.textContent = container.classList.contains('hidden') ? 'Show' : 'Hide';
    }

    /**
     * Handles the file upload event.
     */
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        currentFileName = file.name;
        fileNameDisplay.textContent = `Processing: ${currentFileName}`;
        const originalLabelContent = fileInputLabel.innerHTML;
        fileInputLabel.innerHTML = `<svg class="animate-spin h-6 w-6 inline-block mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;
        fileInput.disabled = true;
        fileInputLabel.classList.add('cursor-not-allowed', 'opacity-75');

        const restoreUploadButton = () => {
            fileInputLabel.innerHTML = originalLabelContent;
            fileInput.disabled = false;
            fileInputLabel.classList.remove('cursor-not-allowed', 'opacity-75');
        };

        const reader = new FileReader();
        reader.onload = function(e) {
            setTimeout(() => { // Simulate processing time for better UX
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('form responses')) || workbook.SheetNames[0];
                    if (!firstSheetName) throw new Error("No valid sheet found.");
                    
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (processData(jsonData)) {
                        displayFormattedFileName();
                        uploadSection.classList.add('hidden');
                        dashboardLayout.classList.remove('hidden');
                        dashboardLayout.classList.add('flex');
                    } else {
                        // processData returned false due to validation error
                        fileNameDisplay.textContent = "Could not process file. Please check columns and try again.";
                        restoreUploadButton();
                    }
                } catch (error) {
                    console.error("File Processing Error:", error);
                    alert(`Error processing XLSX file: ${error.message}. Please ensure it's a valid file.`);
                    fileNameDisplay.textContent = "Could not process file. Please try again.";
                    restoreUploadButton();
                }
            }, 500);
        };
        reader.readAsArrayBuffer(file);
    }
    
    /**
     * Formats and displays the uploaded file name in the header.
     */
    function displayFormattedFileName() {
        if (currentFileName) {
            const formattedName = currentFileName
                .replace(/_ /g, ' ')
                .replace(/\(Responses\)\.xlsx/i, '')
                .trim();
            datasetNameEl.textContent = formattedName;
            datasetNameContainer.classList.remove('hidden');
        }
    }


    /**
     * Processes the parsed data, validates, ranks, and prepares it for visualization.
     * @returns {boolean} - True if processing is successful, false otherwise.
     */
    function processData(data) {
        if (!data || data.length === 0) {
            alert("The uploaded file is empty or could not be read.");
            return false;
        }

        const requiredColumns = ['Score', 'Student Name', 'Student ID', 'Select Your Branch'];
        const headers = Object.keys(data[0]);
        for (const col of requiredColumns) {
            if (!headers.includes(col)) {
                alert(`Error: Missing required column "${col}". Please check your file.`);
                return false;
            }
        }

        questionColumns = headers.filter(h => h.toLowerCase().includes('[question'));

        const processedData = data.map(row => {
            const score = parseInt(row['Score'], 10);
            return {
                id: row['Student ID'] || 'N/A',
                name: row['Student Name'] || 'N/A',
                branch: row['Select Your Branch'] || 'Unknown',
                score: isNaN(score) ? 0 : score,
                responses: questionColumns.reduce((acc, col) => {
                    acc[col] = row[col];
                    return acc;
                }, {})
            };
        }).filter(student => student.name !== 'N/A' && student.id !== 'N/A');

        // Sort and Rank all students
        const sortedStudents = processedData.sort((a, b) => b.score - a.score);
        let rank = 0;
        let lastScore = -1;
        studentData = sortedStudents.map((student, index) => {
            if (student.score !== lastScore) {
                rank = index + 1;
            }
            lastScore = student.score;
            return { ...student, rank };
        });

        populateDashboard();
        return true;
    }

    /**
     * Populates all dashboard elements with processed data.
     */
    function populateDashboard() {
        if (!studentData.length) return;
        
        document.getElementById('score-dist-toggle').checked = false; // Default to count
        document.getElementById('branch-dist-toggle').checked = true; // Default to percentage
        document.getElementById('question-analysis-toggle').checked = true; // Default to percentage

        if (window.ChartDataLabels) {
            Chart.register(ChartDataLabels);
            Chart.defaults.set('plugins.datalabels', {
                color: '#475569', // slate-600
                font: {
                    weight: '500'
                }
            });
        } else {
            console.warn('ChartDataLabels plugin not found.');
        }

        renderTopRankers();
        renderScoreDistributionChart();
        populateBranchFilter();
        renderStudentTable();
        renderBranchCharts();
        populateQuestionSelector();
    }
    
    /**
     * Renders the score distribution histogram with a Google Forms-like style.
     */
    function renderScoreDistributionChart() {
        const ctx = document.getElementById('score-distribution-chart').getContext('2d');
        const scoreDistToggle = document.getElementById('score-dist-toggle');
        const showPercentage = scoreDistToggle ? scoreDistToggle.checked : false;
        
        const scoreRanges = {
            '0-10': 0, '11-20': 0, '21-30': 0, '31-40': 0, '41-50': 0,
            '51-60': 0, '61-70': 0, '71-80': 0, '81-90': 0, '91-100': 0
        };

        studentData.forEach(s => {
            if (s.score <= 10) scoreRanges['0-10']++;
            else if (s.score <= 20) scoreRanges['11-20']++;
            else if (s.score <= 30) scoreRanges['21-30']++;
            else if (s.score <= 40) scoreRanges['31-40']++;
            else if (s.score <= 50) scoreRanges['41-50']++;
            else if (s.score <= 60) scoreRanges['51-60']++;
            else if (s.score <= 70) scoreRanges['61-70']++;
            else if (s.score <= 80) scoreRanges['71-80']++;
            else if (s.score <= 90) scoreRanges['81-90']++;
            else scoreRanges['91-100']++;
        });

        const totalStudents = studentData.length;
        const counts = Object.values(scoreRanges);
        const chartData = showPercentage
            ? counts.map(c => totalStudents > 0 ? (c / totalStudents) * 100 : 0)
            : counts;
        
        const yAxisLabel = showPercentage ? 'Percentage of Students (%)' : 'Number of Students';
        
        if (scoreDistributionChart) scoreDistributionChart.destroy();
        
        scoreDistributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(scoreRanges),
                datasets: [{
                    label: yAxisLabel,
                    data: chartData,
                    backgroundColor: 'rgba(99, 102, 241, 0.8)', // Indigo-500
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                }]
            },
            options: {
                indexAxis: 'x', 
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: yAxisLabel }, 
                        grid: { color: '#e2e8f0' },
                         ticks: {
                             callback: function(value) {
                                return showPercentage ? value.toFixed(1) + '%' : value;
                            }
                        }
                    },
                    x: { 
                        title: { display: true, text: 'Score Range' }, 
                        grid: { display: false }
                    }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        displayColors: false,
                         callbacks: {
                            label: function(context) {
                                let value = context.parsed.y;
                                return showPercentage ? value.toFixed(2) + '%' : value;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#64748b',
                        offset: -4,
                        formatter: (value) => value > 0 ? (showPercentage ? value.toFixed(1) + '%' : value) : '',
                    }
                }
            }
        });
    }

    /**
     * Renders the list of top-ranked students.
     */
    function renderTopRankers() {
        const listContainer = document.getElementById('top-rankers-list');
        if (!listContainer) return;

        let displayCount = 10;
        if (studentData.length > 10) {
            // Ensure all tied ranks at the cutoff are shown
            const tenthRankerScore = studentData[9].score;
            while(displayCount < studentData.length && studentData[displayCount].score === tenthRankerScore) {
                displayCount++;
            }
        } else {
            displayCount = studentData.length;
        }

        listContainer.innerHTML = '';
        if (studentData.length === 0) {
            listContainer.innerHTML = `<p class="text-slate-500 text-sm">No student data to rank.</p>`;
            return;
        }

        const medalColors = ['text-yellow-400', 'text-slate-400', 'text-amber-600'];

        studentData.slice(0, displayCount).forEach((student) => {
            const medalIcon = student.rank <= 3
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${medalColors[student.rank - 1]}" viewBox="0 0 20 20" fill="currentColor">
                     <path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1.618a4.993 4.993 0 00-4.163 4.162V12a1 1 0 102 0v-3.22a3 3 0 013-3h.013a3 3 0 013 3V12a1 1 0 102 0V9.779a4.993 4.993 0 00-4.162-4.162V3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                     <path d="M5.221 14.368a1 1 0 01.44-1.336 4.993 4.993 0 016.678 0 1 1 0 01.44 1.336l-3.339 4.23a1 1 0 01-1.558 0l-3.339-4.23z" />
                   </svg>`
                : `<div class="w-6 h-6 flex items-center justify-center text-sm font-bold text-slate-500">${student.rank}</div>`;

            const listItem = `
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                    <div class="flex items-center min-w-0">
                        <div class="mr-3 flex-shrink-0">${medalIcon}</div>
                        <div class="min-w-0">
                            <p class="font-semibold text-slate-800 truncate">${student.name}</p>
                            <p class="text-xs text-slate-500 truncate">${student.branch}</p>
                        </div>
                    </div>
                    <div class="text-lg font-bold text-indigo-600 ml-2">${student.score}</div>
                </div>
            `;
            listContainer.innerHTML += listItem;
        });
    }

    /**
     * Populates the branch filter dropdowns.
     */
    function populateBranchFilter() {
        const branches = [...new Set(studentData.map(s => s.branch))];
        const branchFilter = document.getElementById('branch-filter-table');
        branchFilter.innerHTML = '<option value="">All Branches</option>'; 
        branches.sort().forEach(branch => {
            const option = document.createElement('option');
            option.value = branch;
            option.textContent = branch;
            branchFilter.appendChild(option);
        });
    }

    /**
     * Renders the filterable student data table.
     */
    function renderStudentTable() {
        const tableBody = document.getElementById('student-table-body');
        const searchTerm = document.getElementById('student-search').value.toLowerCase();
        const selectedBranch = document.getElementById('branch-filter-table').value;

        const filteredData = studentData.filter(s => {
            const matchesSearch = s.name.toLowerCase().includes(searchTerm) || String(s.id).toLowerCase().includes(searchTerm);
            const matchesBranch = selectedBranch === '' || s.branch === selectedBranch;
            return matchesSearch && matchesBranch;
        });

        tableBody.innerHTML = '';
        if (filteredData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-500">No matching students found.</td></tr>`;
            return;
        }

        filteredData.forEach(student => {
            const row = `
                <tr class="hover:bg-slate-50">
                    <td class="py-4 px-6 whitespace-nowrap font-bold text-slate-600">${student.rank}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${student.id}</td>
                    <td class="py-4 px-6 font-medium text-slate-900">${student.name}</td>
                    <td class="py-4 px-6">${student.branch}</td>
                    <td class="py-4 px-6 text-center font-semibold text-indigo-600">${student.score}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    /**
     * Renders the branch distribution and performance charts.
     */
    function renderBranchCharts() {
        const branchData = {};
        studentData.forEach(s => {
            if (!branchData[s.branch]) {
                branchData[s.branch] = { count: 0, totalScore: 0 };
            }
            branchData[s.branch].count++;
            branchData[s.branch].totalScore += s.score;
        });
        
        const sortedBranches = Object.keys(branchData).sort();
        const totalStudents = studentData.length;
        const branchLabels = sortedBranches;
        const branchCounts = sortedBranches.map(b => branchData[b].count);
        const branchPercentages = sortedBranches.map(b => (branchData[b].count / totalStudents) * 100);
        const branchAvgScores = sortedBranches.map(b => (branchData[b].totalScore / branchData[b].count).toFixed(2));
        
        const branchDistToggle = document.getElementById('branch-dist-toggle');
        const showPercentage = branchDistToggle ? branchDistToggle.checked : false;
        const distData = showPercentage ? branchPercentages : branchCounts;
        const yAxisLabel = showPercentage ? 'Percentage of Students (%)' : 'Number of Students';


        // Branch Distribution (Vertical Bar Chart)
        const pieCtx = document.getElementById('branch-distribution-chart').getContext('2d');
        if(branchDistributionChart) branchDistributionChart.destroy();
        
        branchDistributionChart = new Chart(pieCtx, {
            type: 'bar',
            data: {
                labels: branchLabels,
                datasets: [{
                    label: yAxisLabel,
                    data: distData,
                    backgroundColor: 'rgba(14, 165, 233, 0.8)', // Sky-500
                    borderColor: 'rgba(14, 165, 233, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                }]
            },
            options: { 
                indexAxis: 'x',
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: yAxisLabel },
                        grid: { color: '#e2e8f0' },
                        ticks: {
                            callback: function(value) {
                                return showPercentage ? value.toFixed(2) + '%' : value;
                            }
                        }
                    },
                    x: { 
                        grid: { display: false }
                    } 
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                         backgroundColor: '#1e293b',
                         displayColors: false,
                         callbacks: {
                            label: function(context) {
                                let value = context.parsed.y;
                                return showPercentage ? value.toFixed(2) + '%' : value;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#64748b',
                        offset: -4,
                        formatter: (value) => value > 0 ? (showPercentage ? value.toFixed(2) + '%' : value) : '',
                    }
                }
            }
        });

        // Branch Performance (Vertical Bar Chart)
        const barCtx = document.getElementById('branch-performance-chart').getContext('2d');
        if (branchPerformanceChart) branchPerformanceChart.destroy();
        
        branchPerformanceChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: branchLabels,
                datasets: [{
                    label: 'Average Score',
                    data: branchAvgScores,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)', // Green-500
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                }]
            },
            options: {
                indexAxis: 'x',
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Average Score' },
                        grid: { color: '#e2e8f0' }
                    },
                    x: { grid: { display: false } }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: { backgroundColor: '#1e293b', displayColors: false, },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#64748b',
                        offset: -4,
                        formatter: (value) => value > 0 ? value : '',
                    }
                }
            }
        });
    }

    /**
     * Populates the question selector dropdown.
     */
    function populateQuestionSelector() {
        const select = document.getElementById('question-select');
        select.innerHTML = '';
        questionColumns.forEach((q, index) => {
            const option = document.createElement('option');
            option.value = q;
            option.textContent = `Question ${index + 1}`;
            select.appendChild(option);
        });
        if(questionColumns.length > 0) renderQuestionAnalysisChart();
    }

    /**
     * Renders the analysis chart for the selected question.
     */
    function renderQuestionAnalysisChart() {
        const selectedQuestion = document.getElementById('question-select').value;
        if (!selectedQuestion) return;

        const responseCounts = {};
        studentData.forEach(student => {
            const response = student.responses[selectedQuestion] || 'No Response';
            responseCounts[response] = (responseCounts[response] || 0) + 1;
        });
        
        const allPossibleAnswers = ['Answer 01', 'Answer 02', 'Answer 03', 'Answer 04', 'Answer 05'];
        if (responseCounts['No Response']) {
            allPossibleAnswers.push('No Response');
        }

        const questionAnalysisToggle = document.getElementById('question-analysis-toggle');
        const showPercentage = questionAnalysisToggle ? questionAnalysisToggle.checked : false;

        const totalStudents = studentData.length;
        const responseLabels = allPossibleAnswers;
        const counts = allPossibleAnswers.map(answer => responseCounts[answer] || 0);
        const responseData = showPercentage
            ? counts.map(c => totalStudents > 0 ? (c / totalStudents) * 100 : 0)
            : counts;
        
        const yAxisLabel = showPercentage ? 'Percentage of Students (%)' : 'Number of Students';


        const ctx = document.getElementById('question-analysis-chart').getContext('2d');
        if (questionAnalysisChart) questionAnalysisChart.destroy();
        
        questionAnalysisChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: responseLabels,
                datasets: [{
                    label: yAxisLabel,
                    data: responseData,
                    backgroundColor: 'rgba(245, 158, 11, 0.8)', // Amber-500
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                }]
            },
            options: {
                indexAxis: 'x',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: yAxisLabel },
                        grid: { color: '#e2e8f0' },
                        ticks: {
                             callback: function(value) {
                                return showPercentage ? value.toFixed(2) + '%' : value;
                            }
                        }
                    },
                     x: { 
                        grid: { display: false }
                     }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                         backgroundColor: '#1e293b',
                         displayColors: false,
                         callbacks: {
                            label: function(context) {
                                let value = context.parsed.y;
                                return showPercentage ? value.toFixed(2) + '%' : value;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#64748b',
                        offset: -4,
                        formatter: (value) => value > 0 ? (showPercentage ? value.toFixed(2) + '%' : value) : '',
                    }
                }
            }
        });
    }
    
    /**
     * Handles view switching logic.
     */
    function changeView(event, viewName) {
        document.querySelectorAll('.view-content').forEach(content => {
            content.classList.add('hidden');
        });
        sidebarButtons.forEach(button => {
            button.classList.remove('sidebar-active');
        });
        document.getElementById(viewName).classList.remove('hidden');
        event.currentTarget.classList.add('sidebar-active');

        // Update title, special casing for the renamed "Top Rankers" tab
        if (viewName === 'student-performance') {
            viewTitle.textContent = 'Top Rankers';
            document.querySelector('#student-performance h3').textContent = 'Top Rankers List';
        } else {
             viewTitle.textContent = event.currentTarget.textContent.trim();
        }
    }

</script>

</body>
</html>

